name: "Test"

on:
  workflow_call:

env:
  GIT_CONFIG_GLOBAL: "/root/.gitconfig" # fix path in container (https://github.com/actions/runner/issues/2033)

defaults:
  run:
    shell: "bash"

jobs:

  ### LINT ###

  lint:
    runs-on: "ubuntu-latest"
    container:
      image: "ghcr.io/tarantool/sdvg-ci:0.0.1"
    steps:
      - uses: "actions/checkout@v4"

      - name: "Run linter"
        run: "golangci-lint run --print-issued-lines=false --out-format code-climate:lint.json,line-number --timeout 5m"

      - uses: "actions/upload-artifact@v4"
        with:
          name: "codequality"
          path: "lint.json"

  ### UNIT ###

  unit:
    runs-on: "ubuntu-latest"
    container:
      image: "ghcr.io/tarantool/sdvg-ci:0.0.1"
    steps:
      - uses: "actions/checkout@v4"

      - name: "Run unit tests"
        run: "make test/unit"

  ### COVER ###

  cover:
    runs-on: "ubuntu-latest"
    container:
      image: "ghcr.io/tarantool/sdvg-ci:0.0.1"
    steps:
      - uses: "actions/checkout@v4"

      - name: "Measuring test coverage"
        run: "make test/cover | tee coverage.log; exit ${PIPESTATUS[0]}"

      - name: "Upload coverage to badge"
        if: "${{ github.ref_name == github.event.repository.default_branch }}"
        env:
          BADGEN_TOKEN: ${{ secrets.BADGEN_TOKEN }}
        run: |
          RESULT=$(grep -E 'total:\s+\(statements\)\s+[0-9]+\.[0-9]+%' coverage.log | grep -Eo '[0-9]+\.[0-9]+%' | sed 's/%/%25/g')
          curl -LX PUT --header "Authorization: Bearer ${BADGEN_TOKEN}" \
            "https://badgen.net/memo/tarantool-sdvg-coverage-master/coverage/${RESULT}/green"

  ### PERFORMANCE ###

  performance:
    runs-on: "ubuntu-latest"
    container:
      image: "ghcr.io/tarantool/sdvg-ci:0.0.1"
    steps:
      - uses: "actions/checkout@v4"

      - name: "Run benchmarks"
        run: "make test/performance | tee performance.out"
